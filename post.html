<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Post • Silicon: Book of Genesis</title>
    <link rel="stylesheet" href="css/style.css" />
    <meta name="theme-color" content="#000000" />
    <script>
      window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$','$$'], ['\\[','\\]']] } };
    </script>
    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="js/includes.js" defer></script>
  </head>

  <body>
    <div class="layout">
      <div id="sidebar-include" data-src="partials/sidebar.html"></div>
  
      <main class="main">
        <section class="container section">
          <h1 class="post-title" id="title" style="font-size: clamp(28px,5vw,46px);">Loading…</h1>
          <p class="post-meta" id="meta"></p>
          <article id="body" class="post-body post-layout"></article>
        </section>

        <div id="footer-include" data-src="partials/footer.html"></div>
      </main>
    </div>

    <script>

      function repoRoot(){
        const repo = (location.pathname.split('/')[1] || '');
        return repo ? `/${repo}` : '';
      }
      
      async function fetchPostsJSON(){
        const res = await fetch(`${repoRoot()}/posts/posts.json`, { cache: 'no-store' });
        if (!res.ok) throw new Error(`posts.json HTTP ${res.status}`);
        return res.json();
      }

      
      async function loadPost(){
        const usp     = new URLSearchParams(location.search);
        const u       = usp.get('u');
        const titleEl = document.getElementById('title');
        const metaEl  = document.getElementById('meta');
        const bodyEl  = document.getElementById('body');
        if (!u){ titleEl.textContent = 'No post selected'; return; }
    
        try{
          const absUrl = new URL(u, location.href).href;

          const res = await fetch(absUrl, { cache: 'no-store' });

          
          if (!res.ok) throw new Error(`HTTP ${res.status} for ${absUrl}`);
          const html   = await res.text();
          const doc    = new DOMParser().parseFromString(html, 'text/html');
    
          const h1   = doc.querySelector('h1') || doc.querySelector('.post-title');
          const time = doc.querySelector('time[datetime]');
          document.title    = (h1 ? h1.textContent.trim() : 'Post') + ' • Silicon: Book of Genesis';
          titleEl.innerHTML = h1 ? h1.innerHTML : 'Untitled';
          metaEl.textContent = time
            ? new Date(time.getAttribute('datetime')).toLocaleDateString(undefined,{year:'numeric', month:'short', day:'numeric'})
            : '';
    
          const srcRoot = doc.querySelector('article') || doc.querySelector('main') || doc.body;
          const cleaned = srcRoot.cloneNode(true);
          const firstH1   = cleaned.querySelector('h1');            if (firstH1)  firstH1.remove();
          const firstTime = cleaned.querySelector('time[datetime]'); if (firstTime) firstTime.remove();
    
          bodyEl.innerHTML = cleaned.innerHTML;
          bodyEl.addEventListener('click', (e) => {
            const a = e.target.closest('a[href^="#"]');
            if (!a) return;
            const id = a.getAttribute('href').slice(1);
            const target = document.getElementById(id);
            if (target) {
              e.preventDefault();
              target.scrollIntoView({ behavior: 'smooth', block: 'start' });
              history.replaceState(null, '', '#' + id);
            }
          });


          try {
            const posts = await fetchPostsJSON();
          
            const uParam = new URLSearchParams(location.search).get('u') || '';
            const absU   = new URL(uParam, location.href);
            const me = posts.find(p =>
              absU.pathname.endsWith(p.url) || absU.href.endsWith(p.url)
            );
          
            if (me) {
              const cat = me.category || '';
              const sub = me.subcategory || '';
          
              const matches = posts
                .filter(p => p.url !== me.url &&
                             p.category === cat &&
                             (!sub || p.subcategory === sub))
                .sort((a,b) => new Date(b.date) - new Date(a.date))
                .slice(0, 3);
          
              const slot = document.getElementById('similar-list');
              if (slot) {
                const fmt = iso => new Date(iso)
                  .toLocaleString(undefined, { month:'short', year:'numeric' });
          
                slot.innerHTML = matches.length
                  ? matches.map(p => `
                      <a class="similar-card" href="post.html?u=${encodeURIComponent(p.url)}">
                        <strong>${p.titleHtml || p.title}</strong>
                        <span>${p.subcategory ? p.subcategory + ' • ' : ''}${fmt(p.date)}</span>
                      </a>
                    `).join('')
                  : `<p class="muted">No related posts yet.</p>`;
              }
            }
          } catch (err) {
            console.error('Similar reads failed:', err);
            const slot = document.getElementById('similar-list');
            if (slot) slot.innerHTML = `<p class="muted">Couldn’t load suggestions.</p>`;
          }

    

          const baseDir = new URL(absUrl).href.replace(/[^/]*$/, '');
    

          function fixUrl(v){
            if (v && v.startsWith('#')) return v; 
            if (!v || /^([a-z]+:)?\/\//i.test(v) || v.startsWith('/')) return v; 
            if (v.startsWith('img/') || v.startsWith('audio/')) {
              return new URL('../' + v, baseDir).href;
            }

            return new URL(v, baseDir).href;
          }
    
          bodyEl.querySelectorAll('[src]').forEach(el => {
            const v = el.getAttribute('src');
            el.setAttribute('src', fixUrl(v));
          });
          bodyEl.querySelectorAll('a[href]').forEach(a => {
            const v = a.getAttribute('href');
            const fixed = fixUrl(v);
            a.setAttribute('href', fixed);
          });
    
          bodyEl.querySelectorAll('script').forEach(old => {
            const s = document.createElement('script');
            for (const { name, value } of old.attributes) s.setAttribute(name, value);
            s.textContent = old.textContent;
            old.replaceWith(s);
          });

    
          bodyEl.querySelectorAll('a[href]').forEach(a => {
            try{
              const raw = a.getAttribute('href') || '';
              if (raw.startsWith('#')) return;
              const target = new URL(raw, location.href);
              if (/\/posts\/.+\.html?$/i.test(target.pathname)) {
                a.href = 'post.html?u=' + encodeURIComponent(target.href);
              }
            }catch(_){}
          });


          try{
            const seg = location.pathname.split('/')[1] || '';
            const postsRes = await fetch(seg ? `/${seg}/posts/posts.json` : 'posts/posts.json');
            if (postsRes.ok) {
              const posts = await postsRes.json();
          
              const absPost = new URL(u, location.href).href;
              const me = posts.find(p => new URL(p.url, location.href).href === absPost);
          
              const cat = me?.category;
              const sub = me?.subcategory || '';
              const el  = bodyEl.querySelector('#similar-list');
          
              if (el && cat){
                const items = posts
                  .filter(p =>
                    p.category === cat &&
                    (!sub || p.subcategory === sub) &&
                    new URL(p.url, location.href).href !== absPost
                  )
                  .sort((a,b)=> new Date(b.date) - new Date(a.date))
                  .slice(0,3)
                  .map(p => {
                    const href = 'post.html?u=' + encodeURIComponent(p.url);
                    const meta = [
                      p.subcategory || '',
                      new Date(p.date).toLocaleString(undefined, { month: 'short', year: 'numeric' })
                    ].filter(Boolean).join(' • ');
                    return `
                      <a class="similar-card" href="${href}">
                        <strong>${p.titleHtml || p.title}</strong>
                        <span>${meta}</span>
                      </a>`;
                  }).join('');
          
                el.innerHTML = items || `<p class="muted">No related posts yet.</p>`;
              }
            }
          }catch(err){
            const el = bodyEl.querySelector('#similar-list');
            if (el) el.innerHTML = `<p class="muted">Couldn’t load suggestions.</p>`;
            console.warn('Similar reads skipped:', err);
          }

    
          if (window.MathJax?.typeset) MathJax.typeset();
          if (location.hash){
            const target = document.getElementById(location.hash.slice(1));
            if (target) target.scrollIntoView({behavior:'smooth', block:'start'});
          }
        }catch(e){
          console.error('loadPost failed:', e);
          titleEl.textContent = 'Could not load post';
          bodyEl.innerHTML = `<p class="post-body" style="color:#cfcac3">Error loading <code>${(u||'').toString()}</code> — ${e.message}.</p>`;
        }
      }
      loadPost();
    </script>
  </body>
</html>
