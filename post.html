<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Post • Silico: Book of Genesis</title>
  <link rel="stylesheet" href="css/style.css" />
  <meta name="theme-color" content="#000000" />

  <!-- MathJax for LaTeX in posts -->
  <script>
    window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$','$$'], ['\\[','\\]']] } };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>

<body>
  <div class="layout">
    <!-- Sidebar (nav uses Stardos Stencil; titles use Girassol via CSS) -->
    <aside class="sidebar" role="navigation" aria-label="Primary">
      <div class="brand"><a class="site-title" href="index.html">Silico: Book of Genesis</a></div>
      <nav>
        <h3>Pages</h3>
        <ul>
          <li><a href="about.html">The Brain-vat Speaks</a></li>
          <li><a href="categories.html?cat=Book%20Reviews">Book Reviews</a></li>
          <li>
            <a href="categories.html?cat=Fiction">Fiction ▾</a>
            <ul style="margin:.25rem 0 .5rem 12px; padding:0; list-style:none;">
              <li><a href="categories.html?cat=Fiction&sub=Short%20Stories">Short Stories</a></li>
              <li><a href="categories.html?cat=Fiction&sub=Poetry">Poetry</a></li>
            </ul>
          </li>
          <li><a href="categories.html?cat=Mathematics">Mathematics</a></li>
          <li><a href="categories.html?cat=Technology">Technognostics</a></li>
          <li><a href="categories.html?cat=Music">Music</a></li>
          <li><a href="library.html">My Library</a></li>
          <li><a href="categories.html?cat=Miscellaneous">Miscellaneous</a></li>
        </ul>
      </nav>
    </aside>

    <main class="main">
      <section class="container section">
        <h1 class="post-title" id="title" style="font-size: clamp(28px,5vw,46px);">Loading…</h1>
        <p class="post-meta" id="meta"></p>
        <hr class="hr-dots"/>
        <article id="body" class="post-body"></article>
        <p style="margin-top:18px"><a href="index.html">← Back to Home</a></p>
      </section>

      <footer class="container" style="padding:18px 0 30px">
        <small>© <span id="y"></span> Silico: Book of Genesis</small>
      </footer>
    </main>
  </div>

  <script>
    function sanitizeHtml(html){
      // super-light keep-safe: allow basic tags; posts are trusted but we prevent accidental stray <script>
      const t = document.createElement('template');
      t.innerHTML = html;
      t.content.querySelectorAll('script').forEach(n => n.remove());
      return t.innerHTML;
    }

    async function loadPost(){
      const usp = new URLSearchParams(location.search);
      const u = usp.get('u');
      const titleEl = document.getElementById('title');
      const metaEl  = document.getElementById('meta');
      const bodyEl  = document.getElementById('body');

      if(!u){
        titleEl.textContent = 'No post selected';
        return;
      }

      try{
        const res = await fetch(u);
        const html = await res.text();

        // Sniff title, date (if present), and inject
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const h1 = doc.querySelector('h1') || doc.querySelector('.post-title');
        const time = doc.querySelector('time[datetime]');
        titleEl.innerHTML = h1 ? h1.innerHTML : 'Untitled';
        if (time) metaEl.textContent = new Date(time.getAttribute('datetime')).toLocaleDateString(undefined,{year:'numeric', month:'short', day:'numeric'});

        // Body: use article or main content
        const article = doc.querySelector('article') || doc.querySelector('main') || doc.body;
        bodyEl.innerHTML = sanitizeHtml(article.innerHTML);

        // Retarget internal post links
        bodyEl.querySelectorAll('a[href^="posts/"]').forEach(a=>{
          a.href = 'post.html?u=' + encodeURIComponent(a.getAttribute('href'));
        });

        if (window.MathJax?.typeset) MathJax.typeset();

        // Scroll to hash if provided
        if(location.hash) {
          const target = document.getElementById(location.hash.slice(1));
          if(target) target.scrollIntoView({behavior:'smooth', block:'start'});
        }
      }catch(e){
        titleEl.textContent = 'Could not load post';
        bodyEl.innerHTML = `<p class="post-body" style="color:#cfcac3">Error loading <code>${u}</code>.</p>`;
      }
    }
    document.getElementById('y').textContent = new Date().getFullYear();
    loadPost();
  </script>
</body>
</html>
