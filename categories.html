<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Categories • Silicon: Book of Genesis</title>
  <link rel="stylesheet" href="css/style.css" />
  <meta name="theme-color" content="#000000" />
  <script>
    window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$','$$'], ['\\[','\\]']] } };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="js/includes.js" defer></script>
</head>

  
<body>
  <div class="layout">
    <!-- sidebar include -->
    <div id="sidebar-include" data-src="partials/sidebar.html"></div>

    <main class="main">
      <section class="container section">
        <h1 class="site-title" id="catTitle" style="font-size: clamp(28px,5vw,46px);">Categories</h1>
        <hr class="hr-dots"/>
        <div id="posts" class="posts-grid" aria-live="polite"></div>
      </section>

      <!-- footer include -->
      <div id="footer-include" data-src="partials/footer.html"></div>
    </main>
  </div>

  <script>
    function retargetPostLinks(root){
      root.querySelectorAll('a[href^="posts/"]').forEach(a=>{
        a.href = 'post.html?u=' + encodeURIComponent(a.getAttribute('href'));
      });
    }
    async function loadCategory(){
      const grid = document.getElementById('posts');
      const h = document.getElementById('catTitle');
      const usp = new URLSearchParams(location.search);
      const cat = usp.get('cat') || 'All';
      const sub = usp.get('sub') || '';
      h.innerHTML = (sub ? `${cat} • <span style="opacity:.7">${sub}</span>` : cat);
      try{
        const res = (await fetch('posts/posts.json').catch(() => null)) || (await fetch('posts.json'));
        if (!res) throw new Error('Could not fetch posts/posts.json or posts.json');
        const text = await res.text();
        let posts;
        try { posts = JSON.parse(text); }
        catch (e) { throw new Error('posts.json parse error: ' + e.message); }

        const filter = p => (cat==='All' || p.category===cat) && (!sub || p.subcategory===sub);
        const fmt = iso => new Date(iso).toLocaleDateString(undefined,{year:'numeric', month:'short', day:'numeric'});
        const items = posts.filter(filter)
                           .sort((a,b)=> new Date(b.date) - new Date(a.date))
                           .map(p => `
          <article class="post-card" ${
              p.cardImage
                ? (() => {
                    const abs = new URL(p.cardImage, document.baseURI).href;
                    return `style="--card-img: url('${abs}');"`;
                  })()
                : ''
            }>
            <h3><a href="${p.url}">${p.titleHtml || p.title}</a></h3>
            <time class="post-time" datetime="${p.date}">${fmt(p.date)}</time>
            <p class="post-meta">${p.category}${p.subcategory ? ' • ' + p.subcategory : ''}</p>
          </article>
        `).join('');
        grid.innerHTML = items || '<p class="post-body" style="color:#cfcac3">No posts yet.</p>';
        retargetPostLinks(grid);
        if (window.MathJax?.typeset) MathJax.typeset();
        }catch(e){
          console.error('Failed to load posts:', e);
          grid.innerHTML = `<p class="post-body" style="color:#cfcac3">Could not load posts: ${e.message}</p>`;
        }
    }
    loadCategory();
  </script>
</body>
</html>
